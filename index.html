<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1b2e22">
<meta name="mobile-web-app-capable" content="yes">
<title>Shopping List</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f0e8;
  --bg-card: #ffffff;
  --bg-dark: #1b2e22;
  --bg-dark2: #142219;
  --green: #2d6a4f;
  --green-light: #d8f3dc;
  --green-bright: #40916c;
  --text: #1a1a1a;
  --text-muted: #7a7060;
  --text-light: #a89e8e;
  --border: #e2dace;
  --border-light: #ede8df;
  --danger: #d94f4f;
  --shadow: 0 1px 4px rgba(0,0,0,0.06);
  --radius: 14px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body {
  height: 100%; font-family: 'Outfit', -apple-system, sans-serif;
  background: var(--bg); color: var(--text);
  overscroll-behavior: none; -webkit-font-smoothing: antialiased;
}
body { padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); }
#app {
  max-width: 500px; margin: 0 auto; min-height: 100vh;
  display: flex; flex-direction: column;
}

.header {
  background: linear-gradient(145deg, var(--bg-dark) 0%, var(--bg-dark2) 100%);
  padding: 20px 20px 18px; color: #fff; position: sticky; top: 0; z-index: 100;
}
.header-row { display: flex; justify-content: space-between; align-items: center; }
.header h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.02em; }
.header h1 span { margin-right: 6px; }
.header-stats { font-size: 13px; color: rgba(255,255,255,0.55); margin-top: 3px; }

.sync-pill {
  display: flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px;
  font-size: 11px; font-weight: 500; color: rgba(255,255,255,0.8);
  cursor: pointer; border: none;
}
.sync-pill:active { background: rgba(255,255,255,0.2); }
.sync-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; transition: background 0.3s; }
.sync-dot.online { background: #4ade80; }
.sync-dot.syncing { background: #fbbf24; animation: pulse 1s infinite; }
.sync-dot.offline { background: #f87171; }
.sync-dot.nourl { background: #888; }

.settings-btn {
  background: rgba(255,255,255,0.1); border: none; color: #fff;
  width: 34px; height: 34px; border-radius: 10px; font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.settings-btn:active { background: rgba(255,255,255,0.25); }
.header-actions { display: flex; gap: 8px; align-items: center; }

.add-bar { padding: 14px 16px 6px; position: sticky; top: 70px; z-index: 90; background: var(--bg); }
.add-row { display: flex; gap: 8px; align-items: center; }
.add-input {
  flex: 1; height: 48px; border-radius: var(--radius);
  border: 2px solid var(--border); padding: 0 16px;
  font-size: 15px; font-family: 'Outfit', sans-serif;
  background: var(--bg-card); color: var(--text); outline: none;
}
.add-input:focus { border-color: var(--green); }
.add-input::placeholder { color: var(--text-light); }
.add-btn {
  width: 48px; height: 48px; border-radius: var(--radius);
  border: none; background: var(--green); color: #fff;
  font-size: 26px; font-weight: 300; cursor: pointer;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.add-btn:active { transform: scale(0.94); }
.add-btn:disabled { opacity: 0.35; }

.cat-scroller {
  display: flex; gap: 8px; overflow-x: auto; padding: 10px 16px 8px;
  -webkit-overflow-scrolling: touch; scrollbar-width: none;
}
.cat-scroller::-webkit-scrollbar { display: none; }
.cat-chip {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 14px; border-radius: 24px;
  border: 2px solid var(--border); background: var(--bg-card);
  font-size: 13px; font-weight: 500; font-family: 'Outfit', sans-serif;
  color: var(--text-muted); cursor: pointer; white-space: nowrap; flex-shrink: 0;
  transition: all 0.2s;
}
.cat-chip.active { border-color: var(--green); background: var(--green-light); color: var(--green); font-weight: 600; }
.cat-chip:active { transform: scale(0.95); }
.cat-chip .cat-emoji { font-size: 16px; }
.cat-chip .cat-count {
  background: var(--border-light); color: var(--text-muted);
  font-size: 11px; font-weight: 700; padding: 1px 7px; border-radius: 10px;
}
.cat-chip.active .cat-count { background: var(--green); color: #fff; }

.list-area { flex: 1; padding: 4px 16px 120px; }
.group { margin-bottom: 20px; }
.group-header {
  display: flex; align-items: center; gap: 8px;
  padding: 12px 0 8px; font-size: 15px; font-weight: 700; color: var(--text);
}
.group-header .g-emoji { font-size: 20px; }
.group-header .g-count {
  font-size: 11px; font-weight: 700; background: var(--border);
  color: var(--text-muted); padding: 2px 8px; border-radius: 10px; margin-left: auto;
}

.item {
  display: flex; align-items: center; gap: 12px;
  padding: 13px 14px; background: var(--bg-card);
  border-radius: var(--radius); margin-bottom: 5px; box-shadow: var(--shadow);
}
.item:active { transform: scale(0.985); }
.item.just-added { animation: slideIn 0.3s ease-out; }

.cb {
  width: 24px; height: 24px; border-radius: 7px;
  border: 2.5px solid #c0b6a5; background: transparent;
  cursor: pointer; flex-shrink: 0; padding: 0;
}
.cb:active { transform: scale(0.85); }
.item-name { flex: 1; font-size: 15px; font-weight: 500; color: var(--text); }
.item-by { color: var(--text-light); font-size: 12px; font-weight: 400; margin-left: 6px; }
.del-btn {
  border: none; background: transparent; color: var(--text-light);
  font-size: 16px; cursor: pointer; padding: 4px 2px; opacity: 0.4; font-weight: 600;
}
.del-btn:active { opacity: 1; color: var(--danger); }

.done-section { margin-top: 8px; }
.done-header {
  display: flex; align-items: center; gap: 8px; padding: 10px 0;
  cursor: pointer; width: 100%; border: none; background: none; font-family: 'Outfit', sans-serif;
}
.done-toggle { font-size: 13px; color: var(--text-light); }
.done-label {
  font-size: 13px; font-weight: 600; color: var(--text-light);
  text-transform: uppercase; letter-spacing: 0.05em; flex: 1; text-align: left;
}
.clear-all-btn {
  border: 1.5px solid var(--border); background: var(--bg-card);
  color: var(--text-muted); font-size: 11px; font-weight: 600;
  padding: 4px 12px; border-radius: 8px; cursor: pointer; font-family: 'Outfit', sans-serif;
}

.item-done {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 14px; background: rgba(255,255,255,0.45);
  border-radius: var(--radius); margin-bottom: 4px;
}
.cb-done {
  width: 24px; height: 24px; border-radius: 7px;
  border: 2.5px solid var(--green); background: var(--green);
  cursor: pointer; flex-shrink: 0; padding: 0;
  color: #fff; font-size: 14px; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
}
.item-done .item-name { color: var(--text-light); text-decoration: line-through; font-weight: 400; font-size: 14px; }

.empty { text-align: center; padding: 50px 24px; }
.empty-icon { font-size: 52px; margin-bottom: 14px; }
.empty-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
.empty-sub { font-size: 14px; color: var(--text-light); line-height: 1.5; }

.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--bg-dark); color: #fff; padding: 10px 20px;
  border-radius: 12px; font-size: 13px; font-weight: 500;
  z-index: 300; opacity: 0; transition: opacity 0.3s; pointer-events: none;
}
.toast.show { opacity: 1; }

.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 200; display: flex; align-items: flex-end; justify-content: center;
  animation: fadeIn 0.2s;
}
.modal {
  background: var(--bg); width: 100%; max-width: 500px;
  border-radius: 20px 20px 0 0; padding: 24px 20px 40px;
  animation: slideUp 0.3s ease-out; max-height: 85vh; overflow-y: auto;
}
.modal-handle { width: 36px; height: 4px; border-radius: 2px; background: var(--border); margin: 0 auto 18px; }
.modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
.modal label {
  display: block; font-size: 13px; font-weight: 600; color: var(--text-muted);
  margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.04em;
}
.modal input[type="text"], .modal input[type="url"] {
  width: 100%; height: 48px; border-radius: var(--radius);
  border: 2px solid var(--border); padding: 0 14px;
  font-size: 14px; font-family: 'Outfit', sans-serif;
  background: var(--bg-card); color: var(--text); outline: none; margin-bottom: 16px;
}
.modal input:focus { border-color: var(--green); }
.modal .save-btn {
  width: 100%; height: 48px; border-radius: var(--radius);
  border: none; background: var(--green); color: #fff;
  font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Outfit', sans-serif; margin-top: 8px;
}
.modal .save-btn:active { opacity: 0.85; }
.modal p.hint { font-size: 12px; color: var(--text-light); line-height: 1.5; margin-bottom: 16px; }
.modal .section { margin-bottom: 20px; }
.modal .status-box {
  background: var(--bg-card); border-radius: var(--radius);
  padding: 14px; margin-bottom: 16px; border: 1.5px solid var(--border);
}
.modal .status-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; margin-bottom: 6px; }
.modal .status-row:last-child { margin-bottom: 0; }
.modal .status-key { color: var(--text-muted); font-weight: 500; }
.modal .status-val { color: var(--text); font-weight: 600; }
.modal .status-val.ok { color: var(--green); }
.modal .status-val.err { color: var(--danger); }
.modal .test-btn {
  width: 100%; height: 44px; border-radius: var(--radius);
  border: 2px solid var(--green); background: transparent; color: var(--green);
  font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Outfit', sans-serif; margin-bottom: 12px;
}
.modal .test-btn:active { background: var(--green-light); }

@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@keyframes slideIn { from { opacity: 0; transform: translateX(-12px); } to { opacity: 1; transform: translateX(0); } }

.install-banner {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--bg-dark); color: #fff; padding: 16px 20px;
  z-index: 150; display: flex; align-items: center; gap: 14px;
  max-width: 500px; margin: 0 auto; animation: slideUp 0.4s ease-out;
  padding-bottom: calc(16px + var(--safe-bottom));
}
.install-banner p { flex: 1; font-size: 13px; font-weight: 500; line-height: 1.4; }
.install-banner button {
  border: none; padding: 8px 18px; border-radius: 10px;
  font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Outfit', sans-serif; flex-shrink: 0;
}
.install-banner .install-yes { background: var(--green-bright); color: #fff; }
.install-banner .install-no { background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.7); }
</style>
</head>
<body>
<div id="app">
  <div class="header">
    <div class="header-row">
      <div>
        <h1><span>üõí</span>Shopping List</h1>
        <p class="header-stats" id="headerStats">0 items to get</p>
      </div>
      <div class="header-actions">
        <button class="sync-pill" id="syncPill" onclick="manualSync()">
          <span class="sync-dot nourl" id="syncDot"></span>
          <span id="syncLabel">Tap to link</span>
        </button>
        <button class="settings-btn" onclick="openSettings()">‚öô</button>
      </div>
    </div>
  </div>
  <div class="cat-scroller" id="catScroller"></div>
  <div class="add-bar">
    <div class="add-row">
      <input class="add-input" id="addInput" type="text" placeholder="Add an item..." autocomplete="off">
      <button class="add-btn" id="addBtn" onclick="addItem()" disabled>+</button>
    </div>
  </div>
  <div class="list-area" id="listArea"></div>
</div>

<div class="toast" id="toast"></div>

<div class="modal-overlay" id="settingsModal" style="display:none" onclick="closeSettingsIfBg(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2>‚öô Settings</h2>
    <div class="section">
      <label>Google Apps Script URL</label>
      <p class="hint">Deploy the Apps Script as a Web App and paste the URL here. Both phones must use the same URL.</p>
      <input type="url" id="inputApiUrl" placeholder="https://script.google.com/macros/s/.../exec">
    </div>
    <button class="test-btn" onclick="testConnection()">üîó Test Connection</button>
    <div id="testResult"></div>
    <div class="section">
      <label>Your Name</label>
      <p class="hint">So the other person knows who added what.</p>
      <input type="text" id="inputUserName" placeholder="e.g. Rami">
    </div>
    <div class="section">
      <div class="status-box">
        <div class="status-row">
          <span class="status-key">Items (local)</span>
          <span class="status-val" id="statusItems">0</span>
        </div>
        <div class="status-row">
          <span class="status-key">Sync</span>
          <span class="status-val" id="statusSync">‚Äî</span>
        </div>
        <div class="status-row">
          <span class="status-key">Last sync</span>
          <span class="status-val" id="statusTime">Never</span>
        </div>
      </div>
    </div>
    <button class="save-btn" onclick="saveSettings()">Save Settings</button>
  </div>
</div>

<div class="install-banner" id="installBanner" style="display:none">
  <p>üì≤ Install this app on your home screen for the best experience</p>
  <button class="install-yes" onclick="installApp()">Install</button>
  <button class="install-no" onclick="dismissInstall()">Later</button>
</div>

<script>
const CATEGORIES = [
  { id: 'produce',   label: 'Produce',   emoji: 'ü•¨' },
  { id: 'groceries', label: 'Groceries', emoji: 'üõçÔ∏è' },
  { id: 'pharmacy',  label: 'Pharmacy',  emoji: 'üíä' },
  { id: 'mimi',      label: 'Mimi',      emoji: 'üçº' },
  { id: 'others',    label: 'Others',    emoji: 'üì¶' },
];

let items = [];
let selectedCat = 'produce';
let apiUrl = '';
let userName = '';
let showCompleted = true;
let syncTimer = null;
let isSyncing = false;
let lastSyncTime = null;
let syncOk = false;
let deferredPrompt = null;

function init() {
  loadSettings();
  loadItems();
  renderCategories();
  renderList();
  updateHeader();
  updateSyncUI();

  const inp = document.getElementById('addInput');
  inp.addEventListener('input', () => {
    document.getElementById('addBtn').disabled = !inp.value.trim();
  });
  inp.addEventListener('keydown', e => { if (e.key === 'Enter') addItem(); });

  if (apiUrl) {
    setTimeout(() => doSync(), 800);
    syncTimer = setInterval(() => doSync(), 5000);
  }

  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault(); deferredPrompt = e;
    if (!localStorage.getItem('sl_dismissed')) document.getElementById('installBanner').style.display = 'flex';
  });
}

// === LOCAL STORAGE (always saves immediately) ===
function loadSettings() {
  apiUrl = localStorage.getItem('sl_url') || '';
  userName = localStorage.getItem('sl_name') || '';
}
function loadItems() {
  try { items = JSON.parse(localStorage.getItem('sl_items') || '[]'); } catch { items = []; }
}
function saveItems() {
  localStorage.setItem('sl_items', JSON.stringify(items));
}

// === SYNC ===
async function doSync() {
  if (!apiUrl || isSyncing) return;
  isSyncing = true;

  try {
    const res = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'sync', items: items }),
    });
    const data = await res.json();

    if (data.success && Array.isArray(data.items)) {
      const localMap = {};
      items.forEach(i => localMap[i.id] = i);
      const serverMap = {};
      data.items.forEach(i => serverMap[i.id] = i);

      // Add server-only items
      data.items.forEach(si => {
        if (!localMap[si.id]) items.push(si);
        else {
          const li = localMap[si.id];
          if (Number(si.lastModified || 0) > Number(li.lastModified || 0)) {
            li.checked = si.checked; li.lastModified = si.lastModified;
            li.name = si.name; li.category = si.category;
          }
        }
      });

      // Remove locally if deleted on server (only after first successful sync)
      if (lastSyncTime && data.items.length > 0) {
        const sIds = new Set(data.items.map(i => String(i.id)));
        items = items.filter(i => sIds.has(String(i.id)) || Number(i.addedAt) > lastSyncTime);
      }

      saveItems();
      renderList();
      updateHeader();
      syncOk = true;
    }
    lastSyncTime = Date.now();
  } catch (e) {
    console.warn('Sync:', e.message);
    syncOk = false;
  } finally {
    isSyncing = false;
    updateSyncUI();
  }
}

async function pushAction(action, data) {
  if (!apiUrl) return;
  try {
    await fetch(apiUrl, {
      method: 'POST', headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action, ...data }),
    });
  } catch (e) { console.warn('Push:', e.message); }
}

async function manualSync() {
  if (!apiUrl) { openSettings(); return; }
  document.getElementById('syncDot').className = 'sync-dot syncing';
  document.getElementById('syncLabel').textContent = 'Syncing...';
  await doSync();
  showToast(syncOk ? '‚úÖ Synced!' : '‚ö†Ô∏è Sync failed');
}

function updateSyncUI() {
  const dot = document.getElementById('syncDot');
  const label = document.getElementById('syncLabel');
  if (!apiUrl) { dot.className = 'sync-dot nourl'; label.textContent = 'Tap to link'; return; }
  if (syncOk) { dot.className = 'sync-dot online'; label.textContent = 'Synced'; }
  else if (!lastSyncTime) { dot.className = 'sync-dot syncing'; label.textContent = 'Connecting...'; }
  else { dot.className = 'sync-dot offline'; label.textContent = 'Offline'; }
}

// === TOAST ===
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// === CATEGORIES ===
function renderCategories() {
  document.getElementById('catScroller').innerHTML = CATEGORIES.map(cat => {
    const count = items.filter(i => i.category === cat.id && !i.checked).length;
    return `<button class="cat-chip ${selectedCat === cat.id ? 'active' : ''}" onclick="selectCategory('${cat.id}')">
      <span class="cat-emoji">${cat.emoji}</span><span>${cat.label}</span>
      ${count > 0 ? `<span class="cat-count">${count}</span>` : ''}
    </button>`;
  }).join('');
}

function selectCategory(id) {
  selectedCat = id; renderCategories();
  const el = document.getElementById('group-' + id);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  document.getElementById('addInput').focus();
}

// === LIST ===
function renderList() {
  const area = document.getElementById('listArea');
  const active = items.filter(i => !i.checked);
  const checked = items.filter(i => i.checked);

  if (!active.length && !checked.length) {
    area.innerHTML = '<div class="empty"><div class="empty-icon">üìù</div><div class="empty-title">Your list is empty</div><div class="empty-sub">Add items above ‚Äî they sync to the other phone automatically.</div></div>';
    renderCategories(); return;
  }

  let h = '';
  CATEGORIES.forEach(cat => {
    const ci = active.filter(i => i.category === cat.id);
    if (!ci.length) return;
    h += `<div class="group" id="group-${cat.id}">
      <div class="group-header"><span class="g-emoji">${cat.emoji}</span>${cat.label}<span class="g-count">${ci.length}</span></div>
      ${ci.map(item => `<div class="item" id="item-${item.id}">
        <button class="cb" onclick="toggleItem('${item.id}')"></button>
        <span class="item-name">${esc(item.name)}${item.addedBy ? `<span class="item-by">‚Äî ${esc(item.addedBy)}</span>` : ''}</span>
        <button class="del-btn" onclick="deleteItem('${item.id}')">‚úï</button>
      </div>`).join('')}
    </div>`;
  });

  if (checked.length) {
    h += `<div class="done-section">
      <button class="done-header" onclick="toggleCompleted()">
        <span class="done-toggle">${showCompleted ? '‚ñæ' : '‚ñ∏'}</span>
        <span class="done-label">Done (${checked.length})</span>
        <button class="clear-all-btn" onclick="event.stopPropagation();clearChecked()">Clear all</button>
      </button>
      ${showCompleted ? checked.map(item => {
        const cat = CATEGORIES.find(c => c.id === item.category);
        return `<div class="item-done">
          <button class="cb-done" onclick="toggleItem('${item.id}')">‚úì</button>
          <span class="item-name">${cat ? cat.emoji + ' ' : ''}${esc(item.name)}</span>
          <button class="del-btn" onclick="deleteItem('${item.id}')">‚úï</button>
        </div>`;
      }).join('') : ''}
    </div>`;
  }

  area.innerHTML = h;
  renderCategories();
}

// === ACTIONS (save local FIRST, then push) ===
function addItem() {
  const inp = document.getElementById('addInput');
  const name = inp.value.trim();
  if (!name) return;

  const item = { id: gid(), name, category: selectedCat, checked: false, addedAt: Date.now(), addedBy: userName, lastModified: Date.now() };
  items.unshift(item);
  saveItems();
  renderList();
  updateHeader();
  pushAction('add', item);

  inp.value = ''; document.getElementById('addBtn').disabled = true; inp.focus();
  setTimeout(() => { const el = document.getElementById('item-' + item.id); if (el) el.classList.add('just-added'); }, 20);
}

function toggleItem(id) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  item.checked = !item.checked;
  item.lastModified = Date.now();
  saveItems(); renderList(); updateHeader();
  pushAction('toggle', { id });
}

function deleteItem(id) {
  items = items.filter(i => i.id !== id);
  saveItems(); renderList(); updateHeader();
  pushAction('delete', { id });
}

function clearChecked() {
  items = items.filter(i => !i.checked);
  saveItems(); renderList(); updateHeader();
  pushAction('clear_checked', {});
}

function toggleCompleted() { showCompleted = !showCompleted; renderList(); }

function updateHeader() {
  const a = items.filter(i => !i.checked).length;
  const d = items.filter(i => i.checked).length;
  let t = `${a} item${a !== 1 ? 's' : ''} to get`;
  if (d > 0) t += ` ¬∑ ${d} done`;
  document.getElementById('headerStats').textContent = t;
}

// === SETTINGS ===
function openSettings() {
  document.getElementById('inputApiUrl').value = apiUrl;
  document.getElementById('inputUserName').value = userName;
  document.getElementById('testResult').innerHTML = '';
  document.getElementById('statusItems').textContent = items.length;
  const ss = document.getElementById('statusSync');
  if (!apiUrl) { ss.textContent = 'Not configured'; ss.className = 'status-val'; }
  else if (syncOk) { ss.textContent = 'Connected'; ss.className = 'status-val ok'; }
  else { ss.textContent = 'Error'; ss.className = 'status-val err'; }
  const st = document.getElementById('statusTime');
  if (lastSyncTime) { const a = Math.round((Date.now() - lastSyncTime) / 1000); st.textContent = a < 60 ? a + 's ago' : Math.round(a / 60) + 'm ago'; }
  else st.textContent = 'Never';
  document.getElementById('settingsModal').style.display = 'flex';
}

function closeSettingsIfBg(e) { if (e.target === document.getElementById('settingsModal')) document.getElementById('settingsModal').style.display = 'none'; }

async function testConnection() {
  const url = document.getElementById('inputApiUrl').value.trim();
  const r = document.getElementById('testResult');
  if (!url) { r.innerHTML = '<div class="status-box"><div class="status-row"><span class="status-val err">Enter a URL first</span></div></div>'; return; }
  r.innerHTML = '<div class="status-box"><div class="status-row"><span class="status-val">Testing...</span></div></div>';
  try {
    const res = await fetch(url + '?action=list');
    const data = await res.json();
    if (data.success) {
      r.innerHTML = `<div class="status-box"><div class="status-row"><span class="status-key">Status</span><span class="status-val ok">‚úÖ Connected!</span></div><div class="status-row"><span class="status-key">Server items</span><span class="status-val">${(data.items || []).length}</span></div></div>`;
    } else {
      r.innerHTML = `<div class="status-box"><div class="status-row"><span class="status-val err">‚ùå ${data.error || 'Error'}</span></div></div>`;
    }
  } catch (e) {
    r.innerHTML = `<div class="status-box"><div class="status-row"><span class="status-val err">‚ùå Cannot reach server</span></div><div class="status-row"><span class="status-key" style="font-size:11px">${esc(e.message)}</span></div></div>`;
  }
}

function saveSettings() {
  apiUrl = document.getElementById('inputApiUrl').value.trim();
  userName = document.getElementById('inputUserName').value.trim();
  localStorage.setItem('sl_url', apiUrl);
  localStorage.setItem('sl_name', userName);
  document.getElementById('settingsModal').style.display = 'none';
  syncOk = false; lastSyncTime = null; updateSyncUI();
  if (syncTimer) clearInterval(syncTimer);
  if (apiUrl) { doSync(); syncTimer = setInterval(() => doSync(), 5000); }
  showToast('Settings saved');
}

// === PWA ===
function installApp() {
  if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('installBanner').style.display = 'none'; }); }
}
function dismissInstall() { localStorage.setItem('sl_dismissed', '1'); document.getElementById('installBanner').style.display = 'none'; }

// === UTILS ===
function gid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// === MANIFEST & SW ===
const m = { name: "Shopping List", short_name: "Shop List", start_url: "./", display: "standalone", background_color: "#f5f0e8", theme_color: "#1b2e22",
  icons: [{ src: "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="#1b2e22"/><text x="50" y="68" font-size="56" text-anchor="middle">üõí</text></svg>'), sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }] };
const ml = document.createElement('link'); ml.rel = 'manifest'; ml.href = URL.createObjectURL(new Blob([JSON.stringify(m)], { type: 'application/json' })); document.head.appendChild(ml);

if ('serviceWorker' in navigator) {
  const sw = `self.addEventListener('install',()=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(clients.claim()));self.addEventListener('fetch',e=>{if(e.request.url.includes('script.google.com')||e.request.url.includes('fonts.g'))return;e.respondWith(fetch(e.request).then(r=>{const c=r.clone();caches.open('sl-v3').then(ch=>ch.put(e.request,c));return r}).catch(()=>caches.match(e.request)))});`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], { type: 'application/javascript' }))).catch(() => {});
}

const ai = document.createElement('link'); ai.rel = 'apple-touch-icon';
ai.href = "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="#1b2e22"/><text x="50" y="68" font-size="56" text-anchor="middle">üõí</text></svg>');
document.head.appendChild(ai);

init();
</script>
</body>
</html>
